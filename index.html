<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ğŸ„ åœ£è¯æ ‘ + æ‹ç…§</title>
    <style>
        :root { --bg:#0b1020; --card:#121a33; --text:#e9eeff; }
        body{
            margin:0; min-height:100vh; display:grid; place-items:center;
            background:radial-gradient(1200px 800px at 50% 20%, #16214a, var(--bg));
            color:var(--text); font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
        }
        .wrap{ width:min(860px, 92vw); }
        .card{
            background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
            border:1px solid rgba(255,255,255,.10);
            border-radius:20px; padding:18px 16px;
            box-shadow:0 18px 55px rgba(0,0,0,.35);
        }
        h1{ margin:0 0 10px; font-size:18px; font-weight:700; letter-spacing:.5px; opacity:.95;}
        .hint{ margin:8px 0 0; font-size:12px; opacity:.75; line-height:1.5;}
        pre{
            margin:0; padding:14px 14px 16px;
            background:rgba(0,0,0,.18);
            border-radius:14px;
            overflow:auto;
            font-size:18px;
            line-height:1.25;
            white-space:pre;
        }
        .star{ color:#ff4d4d; text-shadow:0 0 14px rgba(255,77,77,.75); }
        .leaf{ color:#32d06a; }
        .trunk{ color:#d7a34a; }
        .light{
            display:inline-block;
            width:1ch;
            filter:drop-shadow(0 0 10px rgba(255,255,255,.35));
            animation:twinkle 1.2s infinite;
        }
        @keyframes twinkle{
            0%,100%{ opacity:.35; transform:scale(0.9); }
            50%{ opacity:1; transform:scale(1.08); }
        }
        .footer{
            display:flex; gap:10px; align-items:center; justify-content:space-between;
            margin-top:10px; opacity:.8; font-size:12px; flex-wrap:wrap;
        }
        button{
            border:1px solid rgba(255,255,255,.16);
            background:rgba(255,255,255,.06);
            color:var(--text);
            padding:8px 10px;
            border-radius:12px;
            cursor:pointer;
            white-space:nowrap;
        }
        button:active{ transform:translateY(1px); }

        .cam{
            margin-top:14px;
            display:grid;
            grid-template-columns: 1fr 1fr;
            gap:12px;
        }
        .panel{
            background:rgba(0,0,0,.18);
            border:1px solid rgba(255,255,255,.10);
            border-radius:14px;
            padding:10px;
        }
        .panel h2{
            margin:0 0 8px;
            font-size:12px;
            opacity:.85;
            font-weight:700;
            letter-spacing:.3px;
        }
        video, canvas{
            width:100%;
            aspect-ratio: 4 / 3;
            background:#000;
            border-radius:12px;
            display:block;
        }
        .row{
            display:flex;
            gap:10px;
            flex-wrap:wrap;
            margin-top:10px;
            align-items:center;
            opacity:.9;
            font-size:12px;
        }
        .status{ opacity:.8; }
    </style>
</head>
<body>
<div class="wrap">
    <div class="card">
        <h1>ğŸ„ Merry Christmas åˆ˜æ…§é¢–</h1>
        <pre id="tree" aria-label="ascii christmas tree"></pre>

        <div class="footer">
            <div>ç¯å…‰ä¼šéšæœºé—ªçƒï¼ˆå¾®ä¿¡å†…ç½®æµè§ˆå™¨å¯ç”¨ï¼‰</div>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <button id="btn">æ¢ä¸€ç»„ç¯å…‰</button>
                <button id="snap">ğŸ“¸ ç‚¹æˆ‘ï¼šæˆæƒå¹¶æ‹ä¸€å¼ </button>
            </div>
        </div>

        <div class="cam">
            <div class="panel">
                <h2>æ‘„åƒå¤´é¢„è§ˆ</h2>
                <video id="video" autoplay playsinline muted></video>
                <div class="row">
                    <span class="status" id="camStatus">æœªå¼€å¯</span>
                    <button id="stop" type="button">åœæ­¢æ‘„åƒå¤´</button>
                </div>
            </div>
            <div class="panel">
                <h2>æ‹ç…§ç»“æœ</h2>
                <canvas id="canvas"></canvas>
                <div class="row">
                    <span class="status" id="shotStatus">æœªæ‹ç…§</span>
                    <button id="download" type="button">ä¸‹è½½ä¸Šä¸€å¼ </button>
                </div>
            </div>
        </div>

        <div class="hint" id="hint"></div>
    </div>
</div>

<script>
    // ===== ä½ çš„åœ£è¯æ ‘é€»è¾‘ï¼ˆåŸæ ·ä¿ç•™ï¼‰ =====
    const height = 12;        // æ ‘é«˜åº¦
    const trunkH = 2;         // æ ‘å¹²é«˜åº¦
    const lightProb = 0.22;   // ç¯å‡ºç°æ¦‚ç‡

    const lightColors = ["#ffd166","#06d6a0","#4cc9f0","#f72585","#bdb2ff","#ff9f1c"];
    const pre = document.getElementById("tree");
    const btn = document.getElementById("btn");

    function randInt(n){ return Math.floor(Math.random()*n); }
    function pick(arr){ return arr[randInt(arr.length)]; }

    function span(cls, text, style=""){
        const s = document.createElement("span");
        if (cls) s.className = cls;
        if (style) s.style = style;
        s.textContent = text;
        return s;
    }

    function buildTree(){
        pre.innerHTML = "";
        const lines = [];

        lines.push({ parts: [ {cls:"", text:" ".repeat(height-1)}, {cls:"star", text:"â˜…"} ] });

        for (let i=0;i<height;i++){
            const pad = " ".repeat(height - i - 1);
            const width = 2*i + 1;
            const parts = [{cls:"", text:pad}];

            for (let j=0;j<width;j++){
                if (Math.random() < lightProb && i>1 && j>0 && j<width-1){
                    const color = pick(lightColors);
                    parts.push({cls:"light", text:"â—", style:`color:${color}; animation-delay:${Math.random()*1.2}s;`});
                } else {
                    parts.push({cls:"leaf", text:"*"});
                }
            }
            lines.push({parts});
        }

        for (let t=0;t<trunkH;t++){
            lines.push({
                parts: [
                    {cls:"", text:" ".repeat(height-1)},
                    {cls:"trunk", text:"|"}
                ]
            });
        }

        for (const line of lines){
            const frag = document.createDocumentFragment();
            for (const p of line.parts){
                frag.appendChild(span(p.cls, p.text, p.style || ""));
            }
            pre.appendChild(frag);
            pre.appendChild(document.createTextNode("\n"));
        }
    }

    buildTree();
    setInterval(buildTree, 1600);
    btn.addEventListener("click", buildTree);

    // ===== æ‘„åƒå¤´ + æ‹ç…§ + ä¸‹è½½ï¼ˆæ–°å¢ï¼‰ =====
    const hint = document.getElementById("hint");
    const snapBtn = document.getElementById("snap");
    const stopBtn = document.getElementById("stop");
    const downloadBtn = document.getElementById("download");
    const camStatus = document.getElementById("camStatus");
    const shotStatus = document.getElementById("shotStatus");

    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");

    let stream = null;
    let lastBlob = null;

    function setHint(msg){ hint.textContent = msg; }

    async function ensureCamera(){
        if (stream) return stream;

        // iOS/å¾®ä¿¡é‡Œæ›´ç¨³ï¼šä¼˜å…ˆ user(å‰ç½®)ï¼Œä½ ä¹Ÿå¯ä»¥æ”¹æˆ environment(åç½®)
        const constraints = {
            audio: false,
            video: {
                facingMode: "user",
                width: { ideal: 1280 },
                height: { ideal: 960 }
            }
        };

        stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;

        // ç­‰ video å…ƒæ•°æ®å°±ç»ª
        await new Promise((resolve) => {
            if (video.readyState >= 2) return resolve();
            video.onloadedmetadata = () => resolve();
        });

        camStatus.textContent = "å·²å¼€å¯";
        setHint("å·²è·å–æ‘„åƒå¤´æƒé™ã€‚");
        return stream;
    }

    function stopCamera(){
        if (!stream) return;
        stream.getTracks().forEach(t => t.stop());
        stream = null;
        video.srcObject = null;
        camStatus.textContent = "æœªå¼€å¯";
        setHint("æ‘„åƒå¤´å·²åœæ­¢ã€‚");
    }

    function timestampName(){
        const d = new Date();
        const pad = (n)=> String(n).padStart(2,"0");
        // ä¾‹å¦‚ photo_20251225_235959.png
        return `photo_${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}.png`;
    }

    async function snapAndDownload(){
        try{
            if (!navigator.mediaDevices?.getUserMedia){
                setHint("å½“å‰ç¯å¢ƒä¸æ”¯æŒ getUserMediaï¼ˆéœ€è¦ç°ä»£æµè§ˆå™¨æˆ– HTTPSï¼‰ã€‚");
                return;
            }

            await ensureCamera();

            // è®¾å®šç”»å¸ƒå°ºå¯¸ä¸è§†é¢‘ä¸€è‡´
            const w = video.videoWidth || 640;
            const h = video.videoHeight || 480;
            canvas.width = w;
            canvas.height = h;

            ctx.drawImage(video, 0, 0, w, h);

            // ç”Ÿæˆ blob ä»¥ä¾¿ä¸‹è½½
            lastBlob = await new Promise((resolve) => canvas.toBlob(resolve, "image/png", 0.95));
            shotStatus.textContent = "å·²æ‹ç…§";

            // è‡ªåŠ¨ä¸‹è½½
            const a = document.createElement("a");
            const url = URL.createObjectURL(lastBlob);
            a.href = url;
            a.download = timestampName();
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);

            setHint("å·²æ‹ç…§å¹¶è§¦å‘ä¸‹è½½ï¼ˆä¸€èˆ¬ä¿å­˜åœ¨â€œä¸‹è½½â€ç›®å½•ï¼‰ã€‚");
        }catch(err){
            console.error(err);
            setHint("æ‹ç…§å¤±è´¥ï¼šå¯èƒ½æœªå…è®¸æƒé™ï¼Œæˆ–éœ€è¦åœ¨ HTTPS/localhost ä¸‹æ‰“å¼€ã€‚");
        }
    }

    function downloadLast(){
        if (!lastBlob){
            setHint("è¿˜æ²¡æœ‰æ‹ç…§ã€‚å…ˆç‚¹â€œæˆæƒå¹¶æ‹ä¸€å¼ â€ã€‚");
            return;
        }
        const a = document.createElement("a");
        const url = URL.createObjectURL(lastBlob);
        a.href = url;
        a.download = timestampName();
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        setHint("å·²ä¸‹è½½ä¸Šä¸€å¼ ã€‚");
    }

    snapBtn.addEventListener("click", snapAndDownload);
    stopBtn.addEventListener("click", stopCamera);
    downloadBtn.addEventListener("click", downloadLast);

    // é¡µé¢å…³é—­æ—¶é‡Šæ”¾æ‘„åƒå¤´
    window.addEventListener("beforeunload", stopCamera);
</script>
</body>
</html>
